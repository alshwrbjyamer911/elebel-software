#include "lora.hpp"
#include <cstring>
#include <cstdio>
UART_HandleTypeDef huart2;
void lora_init(){

	HAL_UART_Transmit(&huart2, band, sizeof(band)-1, 100);
	HAL_UART_Transmit(&huart2, password, sizeof(password)-1, 100);

}
void lora_send(uint8_t *pdata){
	HAL_UART_Transmit(&huart2, pdata, sizeof(pdata)-1, 100);
}

uint8_t lora_recive(){
	//+RCV=<Address>,<Length>,<Data>,<RSSI>,<SNR>
	return receive_message();
}

uint8_t receive_message(){
	memset(uart_rx_buffer,0,100);
	uint8_t cmd;
	HAL_UART_Receive(&huart2, uart_rx_buffer, 100, 100);

	if(strstr((const char*)uart_rx_buffer,"+RCV=")){
		cmd =process_message((const char*)uart_rx_buffer);
	}

	return cmd;
}
uint8_t process_message(const char *message){
	int address = 0;int rssi = 0;int lenth=0;
	uint8_t data=0;
	sscanf(message, "+RCV=%d,%d,%[^,],%d,%d",&address,&lenth,&data,&rssi,NULL);
	return data;
}

